# 实施计划：召唤师战争全链路审计

## 概述

按阵营逐个执行八层链路审计，每个任务是可独立执行的审计+修复单元。先修复已知问题，再逐阵营审计，最后做交叉影响检查。

## 任务

- [x] 1. 修复已知问题（前轮审计发现）
  - [x] 1.1 清理 useGameEvents.ts 中的 [rapid_fire-debug] 遗留调试日志
    - 搜索并删除 `useGameEvents.ts` 第300行附近的 `[rapid_fire-debug]` 日志
    - 运行相关测试确认无回归
    - _Requirements: 10.1_
  - [x] 1.2 修复感染验证中疫病体判断使用常量
    - 在 `domain/abilities.ts` 的 infection customValidator 中，将 `card.id.includes('plague-zombie') || card.name.includes('疫病体')` 替换为 `domain/ids.ts` 中的常量或工具函数
    - 运行感染相关测试确认无回归
    - _Requirements: 10.2_
  - [x] 1.3 修复交缠共享技能读取逻辑
    - 审查 `domain/helpers.ts` 中 `getUnitAbilities` 函数，确认交缠颂歌连接的单位技能共享包含 tempAbilities
    - 如果只读取 `card.abilities`，修改为同时包含 `tempAbilities`
    - 运行交缠相关测试确认无回归
    - _Requirements: 10.3_
  - [x] 1.4 审查念力推拉对角线方向选择逻辑
    - 审查 `domain/helpers.ts` 中 `calculatePushPullPosition` 函数
    - 确认对角线目标时方向选择逻辑合理（优先行方向或列方向）
    - 如果逻辑不合理，修复或添加玩家选择
    - _Requirements: 10.4_

- [x] 2. 核心机制审计
  - [x] 2.1 审计移动机制
    - 审查 `helpers.ts` 中 `canMoveTo`、`getValidMoveTargets`、`getValidMoveTargetsEnhanced`
    - 验证：最多3个单位、各移动2格、禁止对角线、不能穿过卡牌、建筑不可移动
    - 输出八层链路矩阵，记录发现的问题
    - _Requirements: 1.1_
  - [x] 2.2 审计攻击机制
    - 审查 `helpers.ts` 中 `canAttack`、`canAttackEnhanced`、`isRangedPathClear`、`getValidAttackTargets`
    - 验证：近战相邻、远程3格直线+遮挡+护城墙穿透、骰子匹配、不活动惩罚
    - 输出八层链路矩阵，记录发现的问题
    - _Requirements: 1.2, 1.7_
  - [x] 2.3 审计召唤、建造、魔力、抽牌机制
    - 审查 `getValidSummonPositions`、`getValidBuildPositions`、`clampMagic`、`getDrawCount`
    - 审查 `validate.ts` 中对应命令的验证逻辑
    - 审查 `reduce.ts` 中对应事件的状态变更
    - 输出八层链路矩阵，记录发现的问题
    - _Requirements: 1.3, 1.4, 1.5, 1.6, 1.8_

- [x] 3. 检查点 - 确认已知问题修复和核心机制审计完成
  - 运行 `npm test -- src/games/summonerwars/` 确认所有测试通过
  - 确认已知问题修复无回归，如有疑问请询问用户


- [x] 4. 堕落王国（亡灵法师）阵营审计
  - [x] 4.1 审计召唤师能力：复活死灵（revive_undead）
    - 权威描述→原子步骤拆解→八层链路检查
    - 重点：多步交互链（选卡→选位置）、自伤2点、亡灵判定、相邻空格验证
    - 审查文件：`abilities.ts`、`executors/necromancer.ts`、`reduce.ts`、`validate.ts`、UI 交互提示
    - _Requirements: 2.1_
  - [x] 4.2 审计冠军能力：火祀召唤、吸取生命、暴怒
    - 火祀召唤（fire_sacrifice）：消灭友方→放置到该位置
    - 吸取生命（life_drain）：消灭2格内友方→双倍战力
    - 暴怒（rage）：伤害标记数量加成战力
    - 每个能力输出八层链路矩阵
    - _Requirements: 2.2, 2.3, 2.4_
  - [x] 4.3 审计士兵能力：血腥狂怒、献祭、无魂、感染、灵魂转移
    - 血腥狂怒（blood_rage）：任意单位消灭→充能→战力加成→回合结束衰减
    - 献祭（sacrifice）：被消灭→相邻敌方1伤
    - 无魂（soulless）：消灭疫病体不获魔力
    - 感染（infection）：消灭敌方→弃牌堆召唤疫病体（高风险交互）
    - 灵魂转移（soul_transfer）：消灭敌方→可选移动到该位置（高风险交互）
    - _Requirements: 2.5, 2.6, 2.7, 2.8, 2.9_
  - [x] 4.4 审计堕落王国事件卡
    - 地狱火之刃（NECRO_HELLFIRE_BLADE）：附加到单位
    - 葬火（NECRO_FUNERAL_PYRE）：持续事件
    - 歼灭（NECRO_ANNIHILATE）：消灭友方+对目标造成伤害
    - 血之召唤（NECRO_BLOOD_SUMMON）：特殊召唤
    - 每张事件卡输出八层链路矩阵
    - _Requirements: 2.10_

- [x] 5. 欺心巫族阵营审计
  - [x] 5.1 审计召唤师能力：心灵捕获（mind_capture）
    - 权威描述→原子步骤拆解→八层链路检查
    - 重点：攻击伤害≥目标剩余生命时提示选择控制/伤害（高风险交互）
    - 审查攻击流程中的 mind_capture_check 和 mind_capture_resolve
    - _Requirements: 3.1_
  - [x] 5.2 审计冠军能力：飞行、浮空术、高阶念力、稳固、读心传念
    - 飞行（flying）：额外移动1格+穿越所有卡牌
    - 浮空术（aerial_strike）：2格内友方士兵获得飞行光环
    - 高阶念力（high_telekinesis）：攻击后推拉3格内非召唤师1格（高风险交互）
    - 稳固（stable）：免疫推拉
    - 读心传念（mind_transmission）：攻击后给3格内友方士兵额外攻击（高风险交互）
    - _Requirements: 3.2, 3.3, 3.4, 3.5, 3.6_
  - [x] 5.3 审计士兵能力：迅捷、远射、念力、幻化、迷魂、缠斗
    - 迅捷（swift）：额外移动1格
    - 远射（ranged）：攻击范围4格
    - 念力（telekinesis）：攻击后推拉2格内非召唤师1格（高风险交互）
    - 幻化（illusion）：移动阶段开始复制3格内士兵技能（高风险交互）
    - 迷魂（evasion）：相邻敌方攻击掷出✦时减伤1
    - 缠斗（rebound）：相邻敌方离开时造成1伤
    - _Requirements: 3.7, 3.8, 3.9, 3.10, 3.11, 3.12_
  - [x] 5.4 审计欺心巫族事件卡
    - 心灵操控（TRICKSTER_MIND_CONTROL）：传奇，控制敌方单位
    - 风暴侵袭（TRICKSTER_STORM_ASSAULT）：ACTIVE，减少移动
    - 催眠引诱（TRICKSTER_HYPNOTIC_LURE）：拉目标+ACTIVE战力加成
    - 震慑（TRICKSTER_STUN）：推拉+穿过+伤害
    - _Requirements: 3.13_

- [x] 6. 检查点 - 确认堕落王国和欺心巫族审计完成
  - 运行 `npm test -- src/games/summonerwars/` 确认所有测试通过（861 tests, 42 files）
  - 堕落王国：全部通过，无遗留问题
  - 欺心巫族：telekinesis_instead 已修复（链B 代替攻击路径），rebound 推拉触发缺失记录到 task 15.2
  - adapter.ts 重复 createGameEngine 导出已修复（pre-existing issue from openspec work）


- [x] 7. 先锋军团（圣骑士）阵营审计
  - [x] 7.1 审计召唤师能力：城塞之力（fortress_power）
    - 权威描述→原子步骤拆解→八层链路检查
    - 重点：攻击后从弃牌堆拿取城塞单位到手牌（高风险交互）
    - 结果：✅ 全部通过，城塞判定用 id.includes('fortress') 低风险
    - _Requirements: 4.1_
  - [-] 7.2 审计冠军能力：指引、城塞精锐、辉光射击、神圣护盾
    - 指引（guidance）：✅ 召唤阶段开始抓2张牌
    - 城塞精锐（fortress_elite）：✅ 2格内友方城塞单位+1战力
    - 辉光射击（radiant_shot）：✅ 每2点魔力+1战力
    - 神圣护盾（divine_shield）：✅ 3格内友方城塞被攻击时投骰减伤
    - _Requirements: 4.2, 4.3, 4.4, 4.5_
  - [x] 7.3 审计士兵能力：治疗、裁决、缠斗、守卫、圣光箭
    - 治疗（healing）：✅ 攻击友方时弃牌将伤害转为治疗
    - 裁决（judgment）：✅ 攻击后按❤️数量抓牌
    - 缠斗（entangle）：✅ 相邻敌方远离时造成1伤（推拉边界问题同 rebound，已记录 task 15.2）
    - 守卫（guardian）：✅ 相邻敌方攻击时必须攻击守卫
    - 圣光箭（holy_arrow）：✅ 攻击前弃牌获得魔力和战力加成
    - _Requirements: 4.6, 4.7, 4.8, 4.9, 4.10_
  - [x] 7.4 审计先锋军团事件卡
    - 重燃希望（PALADIN_REKINDLE_HOPE）：✅ ACTIVE，任意阶段召唤+召唤师相邻召唤
    - 圣洁审判（PALADIN_HOLY_JUDGMENT）：✅ 传奇/ACTIVE，充能+友方士兵+1战力+消灭减充能+归零弃置
    - 圣灵庇护（PALADIN_HOLY_PROTECTION）：✅ ACTIVE，召唤师3格内友方士兵首次被攻击伤害上限1
    - 群体治疗（PALADIN_MASS_HEALING）：✅ 召唤师2格内友方士兵和英雄移除2伤害
    - _Requirements: 4.11_

- [x] 8. 洞穴地精阵营审计
  - [x] 8.1 审计召唤师能力：神出鬼没（vanish）
    - 权威描述→原子步骤拆解→八层链路检查
    - 重点：攻击阶段与0费友方交换位置（高风险交互）
    - 结果：✅ 全部通过，usesPerTurn=1 + customValidator 完整
    - _Requirements: 5.1_
  - [x] 8.2 审计冠军能力：鲜血符文、力量强化、魔力成瘾、凶残、喂养巨食兽
    - 鲜血符文（blood_rune）：✅ 二选一逻辑完整，魔力不足拒绝充能
    - 力量强化（power_boost）：✅ 复用亡灵法师定义，min(boosts,5) 上限正确
    - 魔力成瘾（magic_addiction）：✅ 自动触发，有/无魔力两条路径完整
    - 凶残（ferocity）：✅ validate.ts 正确绕过 attackCount 限制
    - 喂养巨食兽（feed_beast）：✅ interactionChain 两步选择，自毁/吃友方两条路径完整
    - _Requirements: 5.2, 5.3, 5.4, 5.5, 5.6_
  - [x] 8.3 审计士兵能力：攀爬、冲锋、禁足、抓附
    - 攀爬（climb）：✅ extraMove+1 + canPassThrough=structures
    - 冲锋（charge）：✅ 直线1-4格 + 3格以上 UNIT_CHARGED(+1)
    - 禁足（immobile）：✅ validate + helpers 双重阻止移动
    - 抓附（grab）：✅ GRAB_FOLLOW_REQUESTED + ACTIVATE_ABILITY 两步交互完整
    - _Requirements: 5.7, 5.8, 5.9, 5.10_
  - [x] 8.4 审计洞穴地精事件卡
    - 不屈不挠（GOBLIN_RELENTLESS）：✅ ACTIVE，reduce 中检查 common+非自毁→返回手牌
    - 成群结队（GOBLIN_SWARM）：✅ ACTIVE，calculateEffectiveStrength 中统计相邻友方
    - 群情激愤（GOBLIN_FRENZY）：✅ 传奇，过滤 cost=0+非 summoner
    - 潜行（GOBLIN_SNEAK）：✅ sneakDirections 数组批量推拉
    - _Requirements: 5.11_

- [x] 9. 检查点 - 确认先锋军团和洞穴地精审计完成
  - 运行 `npm test -- src/games/summonerwars/` 确认所有测试通过（861 tests, 42 files）
  - 先锋军团：全部通过，低风险发现（fortress 判定用 id.includes）
  - 洞穴地精：全部通过，无 bug，10个能力+4张事件卡全部 ✅

- [x] 10. 极地矮人阵营审计
  - [x] 10.1 审计召唤师能力：结构变换（structure_shift）
    - 结果：✅ 全部通过，interactionChain 两步+活体结构判定完整
    - _Requirements: 6.1_
  - [x] 10.2 审计冠军能力：寒流、威势、寒冰碎屑、高阶冰霜飞弹
    - 寒流（cold_snap）：✅ auraStructureLife 光环正确（低风险：无独立测试）
    - 威势（imposing）：✅ afterAttack + usesPerTurn=1
    - 寒冰碎屑（ice_shards）：✅ 消耗充能+遍历建筑+去重+活体结构
    - 高阶冰霜飞弹（greater_frost_bolt）：✅ 2格内建筑+活体结构计入
    - _Requirements: 6.2, 6.3, 6.4, 6.6_
  - [x] 10.3 审计士兵能力：冰霜飞弹、践踏、冰霜战斧、活体传送门、活体结构、缓慢
    - 冰霜飞弹（frost_bolt）：✅ 相邻建筑+活体结构计入
    - 践踏（trample）：✅ canPassThrough=units + damageOnPassThrough=1（低风险：无独立测试）
    - 冰霜战斧（frost_axe）：✅ 二选一+附加逻辑完整（低风险：无独立测试）
    - 活体传送门（living_gate）：✅ 被动效果
    - 活体结构（mobile_structure）：✅ 被 frost_bolt/ice_shards/structure_shift 正确识别
    - 缓慢（slow）：✅ extraMove=-1
    - _Requirements: 6.5, 6.7, 6.8, 6.9, 6.10, 6.11_
  - [x] 10.4 审计极地矮人事件卡
    - 寒冰冲撞（FROST_ICE_RAM）：✅ ACTIVE + ice_ram executor 完整
    - 冰川位移（FROST_GLACIAL_SHIFT）：✅ shiftDirections 批量推拉
    - 寒冰修补（FROST_ICE_REPAIR）：✅ 遍历友方建筑移除2伤害
    - 护城墙（FROST_PARAPET）：✅ 远程穿透正确
    - _Requirements: 6.12_

- [x] 11. 炽原精灵阵营审计
  - [x] 11.1 审计召唤师能力：祖灵羁绊（ancestral_bond）
    - 权威描述→原子步骤拆解→八层链路检查
    - 重点：移动后充能3格内友方并转移自身充能（高风险交互）
    - 结果：✅ 全部通过，interactionChain 完整
    - _Requirements: 7.1_
  - [x] 11.2 审计冠军能力：力量强化、预备、连续射击、启悟、撤退
    - 力量强化（power_up）：✅ onDamageCalculation + min(charge,5)
    - 预备（prepare）：✅ costsMoveAction + hasMoved 检查
    - 连续射击（rapid_fire）：✅ afterAttack → UI确认 → ACTIVATE_ABILITY → 消耗充能+EXTRA_ATTACK_GRANTED
    - 启悟（inspire）：✅ activated + 四方向相邻友方充能
    - 撤退（withdraw）：✅ interactionChain 两步（costType→position）+ 充能/魔力二选一
    - _Requirements: 7.2, 7.3, 7.4, 7.5, 7.6_
  - [x] 11.3 审计士兵能力：威势、生命强化、速度强化、聚能、祖灵交流
    - 威势（intimidate）：✅ afterAttack + usesPerTurn=1（低风险：无敌方目标检查，但正常攻击流程强制攻击敌方）
    - 生命强化（life_up）：✅ passive + getEffectiveLife 处理 + min(charge,5)
    - 速度强化（speed_up）：✅ onMove + getMovementEnhancements 处理 + min(boosts,5)
    - 聚能（gather_power）：✅ onSummon + addCharge self +1
    - 祖灵交流（spirit_bond）：✅ interactionChain 两步（choice→target(optional)）+ self/transfer 二选一
    - _Requirements: 7.7, 7.8, 7.9, 7.10, 7.11_
  - [x] 11.4 审计炽原精灵事件卡
    - 力量颂歌（BARBARIC_CHANT_OF_POWER）：✅ 传奇，grantedAbility='power_up' → tempAbilities
    - 生长颂歌（BARBARIC_CHANT_OF_GROWTH）：✅ 目标+相邻友方各充能+1
    - 交缠颂歌（BARBARIC_CHANT_OF_ENTANGLEMENT）：✅ ACTIVE，entanglementTargets + getUnitAbilities 双向共享
    - 编织颂歌（BARBARIC_CHANT_OF_WEAVING）：✅ ACTIVE，validate 扩展召唤位置 + execute 召唤时充能目标
    - 低风险：useEventCardModes.ts 所有事件卡 case 使用字符串字面量而非 CARD_IDS 常量（系统性风格问题，执行层/验证层已正确使用常量）
    - _Requirements: 7.12_

- [x] 12. 检查点 - 确认极地矮人和炽原精灵审计完成
  - 运行 `npm test -- src/games/summonerwars/` 确认所有测试通过（861 tests, 42 files）
  - 极地矮人：全部通过（task 10 已完成）
  - 炽原精灵：全部通过，12个能力+4张事件卡全部 ✅
  - 低风险发现：intimidate 无敌方目标检查（极端边界）、useEventCardModes.ts 字符串字面量（系统性风格问题）

- [x] 13. UI 交互提示友好性审查
  - [x] 13.1 审查所有高风险交互能力的 UI 提示
    - AbilityButtonsPanel：数据驱动，从 AbilityDef.ui 自动渲染按钮，无硬编码
    - StatusBanners：覆盖所有高风险交互能力（18个），每个都有对应 i18n 翻译
    - zh-CN 和 en 翻译同步完整
    - 所有多步交互（revive_undead/infection/blood_summon/annihilate/frost_axe/withdraw/ice_ram）都有分步提示
    - 所有"可选"效果（soul_transfer/rapid_fire/feed_beast）都有确认/跳过按钮
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_
  - [x] 13.2 修复发现的 UI 提示问题
    - 无需修复，所有 UI 提示完整且友好
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_

- [x] 14. 审计反模式与数据查询一致性检查
  - [x] 14.1 "可以/可选"效果交互确认检查
    - 逐个检查17个含"你可以"的能力，全部有玩家确认 UI（确认/跳过/选择按钮）
    - 无自动执行的可选效果
    - _Requirements: 9.1_
  - [x] 14.2 测试层全链路覆盖验证
    - 各阵营测试文件覆盖"命令→事件→状态变更"全链路
    - 炽原精灵测试尤其完整：rapid_fire 6个测试、life_up 集成测试验证 reduce 后状态
    - _Requirements: 9.2, 9.3_
  - [x] 14.3 限定条件全程约束检查
    - 所有限定条件在 customValidator 中全程强制约束
    - 无 grantExtra* 全局额度实现（炽原精灵不涉及此模式）
    - _Requirements: 9.4_
  - [x] 14.4 数据查询一致性 grep 审查
    - `.card.abilities`：3处绕过均在 getUnitAbilities/getUnitBaseAbilities 内部（合法），1处在 attachedUnits 场景（合法）
    - `.card.strength`：4处均在 calculateEffectiveStrength 内部或事件 payload 记录（合法）
    - `.card.life`：**修复1处 bug**：BoardGrid.tsx 血条渲染直接读 `unit.card.life` 而非 `getEffectiveLife(unit, core)`，导致有 life_up 的雌狮血条显示不准确。已修复为 `getEffectiveLife(unit, core)`
    - `.tsx` 文件无绕过
    - _Requirements: 9.5, 9.6_

- [x] 15. 交叉影响检查
  - [x] 15.1 检查共享技能 ID 和控制权转移
    - power_boost 在 abilities.ts 定义一次，洞穴地精复用，abilityRegistry 全局唯一 ID 无冲突
    - entangle（先锋军团）和 rebound（欺心巫族）是不同 ID，无冲突
    - CONTROL_TRANSFERRED 正确更新 owner，被控制单位能力通过 getUnitAbilities 查询不受影响
    - mind_control 临时控制：originalOwner 保存，TURN_CHANGED 时通过解构归还
    - _Requirements: 11.1, 11.2_
  - [x] 15.2 检查临时能力叠加和推拉免疫
    - tempAbilities 在 TURN_CHANGED 时通过解构清除（幻化/力量颂歌均覆盖）
    - entanglementTargets 在目标被消灭时通过后处理3自动弃置交缠颂歌
    - stable 推拉免疫全量检查（5个敌方推拉来源）：
      - telekinesis/high_telekinesis（trickster.ts）：✅ getUnitAbilities 检查
      - stun（eventCards.ts）：✅ getUnitAbilities 检查（伤害仍生效）
      - hypnotic_lure（eventCards.ts）：✅ getUnitAbilities 检查
      - abilityResolver pushPull 通用处理器（imposing）：✅ getUnitAbilities 检查
      - **ice_ram（frost.ts）：🔧 修复 — 缺少 stable 检查，已添加**
    - 非敌方推拉（sneak/glacial_shift/structure_shift）：仅移动友方，无需 stable 检查
    - 叠加冲突检查：tempAbilities（幻化复制）+ entanglement（交缠共享）可同时存在，getUnitAbilities 正确合并去重
    - _Requirements: 11.3, 11.4_

- [x] 16. 最终检查点 - 审计完成
  - 运行 `npm test -- src/games/summonerwars/` 确认所有测试通过（861 tests, 42 files）
  - 修复2处 bug：
    - BoardGrid.tsx 血条渲染绕过 getEffectiveLife，导致 life_up 单位血条显示不准确（Task 14）
    - ice_ram 推拉缺少 stable 免疫检查（Task 15）
  - 低风险发现汇总：
    - intimidate 无敌方目标检查（极端边界，正常攻击流程强制攻击敌方）
    - useEventCardModes.ts 所有 case 使用字符串字面量而非 CARD_IDS 常量（系统性风格问题）
    - trample/frost_axe/cold_snap 无独立测试（被集成测试覆盖）
  - 6个阵营（堕落王国/欺心巫族/先锋军团/洞穴地精/极地矮人/炽原精灵）全部审计完成
  - 全部能力（50+）和事件卡（24张）八层链路矩阵输出完毕

## 备注

- 每个审计任务输出八层链路矩阵，发现问题立即修复
- 高风险能力（需要玩家交互的）优先审计
- 修复后运行相关测试确认无回归
- 检查点任务确保阶段性验证
- 审计报告记录所有发现，按严重度分类
- 审计方法论遵循 `docs/ai-rules/testing-audit.md`，六步流程：锁定权威描述→拆分交互链（含自检）→逐链追踪八层→grep消费点→交叉影响→数据查询一致性
- 审计反模式清单（9条）在每个能力审查时逐条检查
- 测试层标 ✅ 的条件：覆盖"命令→事件→状态变更"全链路（事件发射 ≠ 状态生效）

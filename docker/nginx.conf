server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # ── gzip 压缩 ──
  # 未开启 gzip 时，JS/CSS 以原始大小传输，12MB 资源 = 12MB 传输
  # 开启后预期传输量降至 3-4MB，首屏加载提速 3-4 倍
  gzip on;
  gzip_min_length 256;
  gzip_comp_level 6;
  gzip_vary on;
  gzip_proxied any;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    image/svg+xml
    application/wasm;

  # ── 静态资源缓存 ──
  # Vite 构建产物（/assets/ 下的 JS/CSS 带 content hash）→ 永久缓存
  # 游戏素材（图片/音频）→ 7 天缓存
  location /assets/ {
    location ~* \.[0-9a-f]{8}\.(?:js|css)$ {
      expires 1y;
      add_header Cache-Control "public, immutable";
    }
    expires 7d;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  location / {
    try_files $uri $uri/ /index.html;
  }

  location /games/ {
    proxy_pass http://game-server:18000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location /default/ {
    proxy_pass http://game-server:18000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 3600;
    proxy_send_timeout 3600;
  }

  location /lobby-socket/ {
    proxy_pass http://game-server:18000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 3600;
    proxy_send_timeout 3600;
  }

  location /auth/ {
    proxy_pass http://auth-server:18001;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location /notifications/ {
    proxy_pass http://auth-server:18001;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}

# Monk 测试覆盖补充计划

## 目标
对 Monk 实现"效果正确性全覆盖"（每个能力/效果分支都有可重复的行为断言）

## 现状分析

### 已有测试覆盖
- ✅ 基础流程（选角、准备、阶段推进）
- ✅ 技能触发条件（小顺、大顺、3拳、4莲花、3太极、3拳+1掌、3掌）
- ✅ 状态效果（和谐获得太极、定水神拳获得太极+闪避、花开见佛太极满值）
- ✅ 卡牌效果（内心平静、佛光普照、深思、掌击）
- ✅ 技能升级（清修 II、拳法 II、和谐 II）
- ✅ 防御阶段（清修防御结算）
- ✅ 雷霆万钧奖励骰重掷（有太极/无太极/太极不足/跳过重掷/超过次数限制）
- ✅ 击倒状态（花费2CP移除、CP不足无法移除、未移除跳过攻击阶段）
- ✅ 净化Token（移除击倒、无负面状态不可使用）

### 缺失测试覆盖

#### 1. ultimate transcendence（超脱）- 完全缺覆盖
**定义位置**: `src/games/dicethrone/monk/abilities.ts:208`

**触发条件**: 5个莲花骰（`{ [DICE_FACE_IDS.LOTUS]: 5 }`）

**效果分支**:
1. 造成10伤害
2. 命中后给对手击倒状态
3. 获得闪避Token（preDefense时机）
4. 获得净化Token（preDefense时机）
5. 太极上限+1并补满（命中后，postDamage时机）

**需要补充的测试**:
- ✅ 测试用例1: 超脱命中后的完整效果链
  - 骰子: [6,6,6,6,6] → 5个莲花
  - 断言: 对手HP-10、对手击倒=1、自己闪避=1、自己净化=1、自己太极=6（上限+1并补满）

#### 2. zen-forget（禅忘）- 需要断言二选一分支
**定义位置**: `src/games/dicethrone/monk/abilities.ts:62`

**触发条件**: 3个太极骰（`{ [DICE_FACE_IDS.TAIJI]: 3 }`）

**效果分支**:
1. 获得5太极
2. 二选一: 获得闪避Token 或 获得净化Token（preDefense时机）

**需要补充的测试**:
- ✅ 测试用例2: 禅忘选择闪避
  - 骰子: [4,4,4,1,1] → 3个太极
  - 选择: 闪避
  - 断言: 太极=5、闪避=1、净化=0
- ✅ 测试用例3: 禅忘选择净化
  - 骰子: [4,4,4,1,1] → 3个太极
  - 选择: 净化
  - 断言: 太极=5、闪避=0、净化=1

#### 3. taiji-combo（太极连环拳）- rollDie 四分支 + 莲花二选一
**定义位置**: `src/games/dicethrone/monk/abilities.ts:125`

**触发条件**: 3拳+1掌（`{ [DICE_FACE_IDS.FIST]: 3, [DICE_FACE_IDS.PALM]: 1 }`）

**效果分支**:
1. rollDie 投掷1颗骰子，根据结果:
   - 拳头: +2伤害
   - 掌: +3伤害
   - 太极: 获得2太极Token
   - 莲花: 二选一（闪避 或 净化）
2. 基础伤害6 + rollDie累加的bonusDamage

**需要补充的测试**:
- ✅ 测试用例4: 太极连环拳 rollDie=拳头
  - 进攻骰: [1,1,1,3,4] → 3拳+1掌
  - rollDie结果: 1 → 拳头
  - 断言: 对手HP-8（6+2）、太极=0
- ✅ 测试用例5: 太极连环拳 rollDie=掌
  - 进攻骰: [1,1,1,3,4] → 3拳+1掌
  - rollDie结果: 3 → 掌
  - 断言: 对手HP-9（6+3）、太极=0
- ✅ 测试用例6: 太极连环拳 rollDie=太极
  - 进攻骰: [1,1,1,3,4] → 3拳+1掌
  - rollDie结果: 4 → 太极
  - 断言: 对手HP-6、太极=2
- ✅ 测试用例7: 太极连环拳 rollDie=莲花 选择闪避
  - 进攻骰: [1,1,1,3,4] → 3拳+1掌
  - rollDie结果: 6 → 莲花
  - 选择: 闪避
  - 断言: 对手HP-6、闪避=1、净化=0
- ✅ 测试用例8: 太极连环拳 rollDie=莲花 选择净化
  - 进攻骰: [1,1,1,3,4] → 3拳+1掌
  - rollDie结果: 6 → 莲花
  - 选择: 净化
  - 断言: 对手HP-6、闪避=0、净化=1

#### 4. meditation（清修）- 需要断言不同防御骰组合的数值
**定义位置**: `src/games/dicethrone/monk/abilities.ts:197`

**触发条件**: 防御阶段（`{ type: 'phase', phaseId: 'defensiveRoll', diceCount: 4 }`）

**效果分支**:
1. customAction 'meditation-taiji': 按太极骰面数获得太极Token
2. customAction 'meditation-damage': 按拳骰面数对攻击方造成伤害

**需要补充的测试**:
- ✅ 测试用例9: 清修防御骰=2太极+2拳
  - 防御骰: [4,4,1,1] → 2太极+2拳
  - 断言: 防御方太极=2、攻击方HP-2
- ✅ 测试用例10: 清修防御骰=3太极+1拳
  - 防御骰: [4,4,4,1] → 3太极+1拳
  - 断言: 防御方太极=3、攻击方HP-1
- ✅ 测试用例11: 清修防御骰=4太极+0拳
  - 防御骰: [4,4,4,4] → 4太极+0拳
  - 断言: 防御方太极=4、攻击方HP不变
- ✅ 测试用例12: 清修防御骰=0太极+4拳
  - 防御骰: [1,1,1,1] → 0太极+4拳
  - 断言: 防御方太极=0、攻击方HP-4

#### 5. evasive Token - rollToNegate 成功/失败对伤害结算的影响
**定义位置**: `src/games/dicethrone/monk/tokens.ts:51`

**行为**:
- 在 beforeDamageReceived 时机触发
- 投掷1颗骰子，1-2成功规避伤害，3-6失败
- 无论成功失败都消耗1个闪避Token

**需要补充的测试**:
- ✅ 测试用例13: 闪避Token成功规避伤害
  - 初始状态: 防御方闪避=1
  - 攻击: 拳法3拳（4伤害）
  - 闪避判定: 1 → 成功
  - 断言: 防御方HP不变、闪避=0
- ✅ 测试用例14: 闪避Token失败未规避伤害
  - 初始状态: 防御方闪避=1
  - 攻击: 拳法3拳（4伤害）
  - 闪避判定: 3 → 失败
  - 断言: 防御方HP-4、闪避=0

## 工程量评估

### 最正确方案: 命令级补齐（不用E2E穷举）
- **位置**: `src/games/dicethrone/__tests__/flow.test.ts`
- **新增用例数**: 14个
- **时间**: 0.5-1.5人日（如果命令/交互闭环都已具备）
- **不确定点**: choice/rollToNegate 是否完全在 domain 层有可驱动的命令与可稳定断言的状态字段

### 依据
- 测试规范对命令级覆盖的硬性要求（`docs/automated-testing.md:120`）
- E2E 只要求完整用户链路，不适合穷举所有能力/效果

## 实施步骤

1. ✅ 补充 transcendence 测试（1个用例）
2. ✅ 补充 zen-forget 二选一测试（2个用例）
3. ✅ 补充 taiji-combo rollDie 分支测试（5个用例）
4. ✅ 补充 meditation 不同防御骰组合测试（4个用例）
5. ✅ 补充 evasive Token rollToNegate 测试（2个用例）
6. ✅ 运行测试确保通过
7. ✅ 更新测试文档

## 风险与不确定点

1. **choice 命令入口**: 需要确认 zen-forget 和 taiji-combo 的二选一是否有对应的命令可以驱动
2. **rollToNegate 状态可观测性**: 需要确认闪避判定的结果是否可以通过状态字段断言
3. **customAction 可测性**: meditation 的两个 customAction 是否有可稳定断言的状态字段

如果上述不确定点存在问题，需要先补充可测性（增加命令入口/状态字段），可能推高工期到2-3人日。

## 总结

- **目标**: Monk "效果正确性全覆盖"（每个能力/效果分支都有可重复的行为断言）
- **结论**: 最正确方案是补齐命令级测试（`src/games/dicethrone/__tests__/flow.test.ts`）；E2E 保持少量全链路回归即可
- **依据**: 测试规范对命令级覆盖的硬性要求（`docs/automated-testing.md:120`）
- **可选方案**:
  - A) 全量补齐（满足全覆盖）
  - B) 只补 ultimate + 复杂分支（taiji-combo/meditation/evasive），其余保持可用性（不满足全覆盖）
- **风险/不确定点**: choice/rollToNegate 的命令入口与状态可观测性不足会增加额外改造成本
